name: Java CI/CD with Docker Compose

on:
  push:
    branches: [ "develop", "main" ]
  pull_request:
    branches: [ "develop", "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      ### 1️⃣ Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      ### 2️⃣ JDK 17 설정
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      ### 3️⃣ Gradle 빌드
      - name: Build with Gradle
        run: ./gradlew clean build -x test

      ### 4️⃣ Docker 로그인
      - name: Docker login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      ### 5️⃣ Docker Compose로 이미지 빌드 및 푸시
      - name: Build and push via Docker Compose
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_REPOSITORY: ${{ secrets.DOCKERHUB_REPOSITORY }}
        run: |
          echo "✅ Using image: ${DOCKERHUB_USERNAME}/${DOCKERHUB_REPOSITORY}"
          # Compose에서 설정된 image 필드 기준으로 빌드 및 푸시
          docker compose -f docker-compose.yml build
          docker compose -f docker-compose.yml push

      ### 6️⃣ EC2 배포
      - name: Deploy to EC2 via docker-compose
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "==== DEPLOY START ===="

            cd ~/Yummy-pass-was || exit 1

            echo "Pulling latest from develop branch..."
            git fetch --all
            git reset --hard origin/develop

            echo "Pulling latest image..."
            docker compose pull

            echo "Generating .env file..."
            cat > .env <<EOL
            DB_URL=${{secrets.DB_URL}}
            DB_USERNAME=${{secrets.DB_USERNAME}}
            DB_PASSWORD=${{secrets.DB_PASSWORD}}
            NAVER_CLIENT_ID=${{secrets.NAVER_CLIENT_ID}}
            NAVER_CLIENT_SECRET=${{secrets.NAVER_CLIENT_SECRET}}
            KAKAO_CLIENT_ID=${{secrets.KAKAO_CLIENT_ID}}
            GOOGLE_CLIENT_ID=${{secrets.GOOGLE_CLIENT_ID}}
            GOOGLE_CLIENT_SECRET=${{secrets.GOOGLE_CLIENT_SECRET}}
            S3_ACCESS_KEY=${{secrets.S3_ACCESS_KEY}}
            S3_SECRET_KEY=${{secrets.S3_SECRET_KEY}}
            S3_BUCKET_NAME=${{secrets.S3_BUCKET_NAME}}
            EOL

            echo "Restarting container..."
            docker compose --env-file .env down
            docker compose --env-file .env up -d --build

            echo "Containers status:"
            docker ps -a
            echo "==== DEPLOY COMPLETED SUCCESSFULLY ===="
# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.
# This workflow will build a Java project with Gradle and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-gradle

name: Java CI with Gradle

on:
  push:
    branches: [ "develop", "main" ]
  pull_request:
    branches: [ "develop", "main" ]
  workflow_dispatch:

jobs:
  build:

    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # Gradle wrapper에 실행 권한 부여
      - name: Give Gradle wrapper execute permissions
        run: chmod +x ./gradlew
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      ### Gradle Build (테스트 제외)
      - name: Build with Gradle Wrapper
        run: ./gradlew build -x test

      ### Docker 로그인
      - name: Docker login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}


      - name: Debug Secrets
        run: |
          echo "USERNAME length: ${#USERNAME}"
          echo "REPO length: ${#REPO}"
        env:
          USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          REPO: ${{ secrets.DOCKERHUB_REPOSITORY }}
        
      ###  Docker 이미지 빌드 및 푸시
      - name: Build and push Docker image
        run: |
          echo "=== Checking DockerHub Secrets ==="
          echo "USERNAME: '${{ secrets.DOCKERHUB_USERNAME }}'"
          echo "REPOSITORY: '${{ secrets.DOCKERHUB_REPOSITORY }}'"

          USER=$(echo "${{ secrets.DOCKERHUB_USERNAME }}" | tr -d '[:space:]')
          REPO=$(echo "${{ secrets.DOCKERHUB_REPOSITORY }}" | tr -d '[:space:]')

          echo "Using repository -> $USER/$REPO"

          docker build -t $USER/$REPO:${{ github.sha }} -f ./Dockerfile .
          docker push $USER/$REPO:${{ github.sha }}

          docker tag $USER/$REPO:${{ github.sha }} $USER/$REPO:latest
          docker push $USER/$REPO:latest
#      - name: Build and push Docker image
#        run: |
#          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_REPOSITORY }}:latest -f ./Dockerfile .
#          docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_REPOSITORY }}:latest
#
#          docker tag  ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_REPOSITORY }}:latest \
#                  ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_REPOSITORY }}:latest
#          docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_REPOSITORY }}:latest

      ###  EC2 배포
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "Starting deployment..."
            cd ~/Yummy-pass-was

            echo "Pulling latest changes from main branch..."
            git fetch --all
            git reset --hard origin/develop

            echo "Pulling latest Docker image..."
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_REPOSITORY }}:${{ github.sha }}

            echo "Setting environment variables..."
            cat > .env <<EOL
            DB_URL=${{secrets.DB_URL}}
            DB_USERNAME=${{secrets.DB_USERNAME}}
            DB_PASSWORD=${{secrets.DB_PASSWORD}}

            NAVER_CLIENT_ID=${{secrets.NAVER_CLIENT_ID}}
            NAVER_CLIENT_SECRET=${{secrets.NAVER_CLIENT_SECRET}}
            
            KAKAO_CLIENT_ID=${{secrets.KAKAO_CLIENT_ID}}
            NAVER_CLIENT_SECRET=${{secrets.NAVER_CLIENT_SECRET}}

            GOOGLE_CLIENT_ID=${{secrets.GOOGLE_CLIENT_ID}}
            GOOGLE_CLIENT_SECRET=${{secrets.GOOGLE_CLIENT_SECRET}}
            
            S3_ACCESS_KEY=${{secrets.S3_ACCESS_KEY}}
            S3_SECRET_KEY=${{secrets.S3_SECRET_KEY}}
            S3_BUCKET_NAME=${{secrets.S3_BUCKET_NAME}}

            DOCKER_IMAGE=${{secrets.DOCKERHUB_USERNAME}}/${{secrets.DOCKERHUB_REPOSITORY}}:${{github.sha}}
            EOL

            echo "Stopping spring-boot-app container..."
            docker-compose --env-file .env stop app || true

            echo "Removing spring-boot-app container..."
            docker-compose --env-file .env rm -f app || true

            echo "Recreating spring-boot-app service with docker-compose..."
            docker-compose --env-file .env up -d --no-deps --build app

            echo "Checking Docker containers..."
            docker-compose ps
            echo "Deployment completed successfully!"
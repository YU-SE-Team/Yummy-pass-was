name: Java CI/CD with Docker Compose

on:
  push:
    branches: [ "develop", "main" ]
  pull_request:
    branches: [ "develop", "main" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      ### 1️⃣ Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      ### 2️⃣ JDK 17 설정
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      ### 4️⃣ Docker Hub 로그인
      - name: Docker login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      ### 5️⃣ Docker Compose로 이미지 빌드 및 푸시
      - name: Build and push via Docker Compose
        run: |
          docker compose -f docker-compose.yml build app
          docker compose -f docker-compose.yml push app

      ### 6️⃣ EC2 배포
      - name: Deploy to EC2 via docker-compose
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "==== DEPLOY START ===="

            cd ~/Yummy-pass-was || exit 1

            git fetch --all
            git reset --hard origin/develop

            echo "Generating .env file..."
            cat > .env <<EOL
            DB_URL=${{ secrets.DB_URL }}
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}
            NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}
            KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            SERVER_ACCESS_KEY=${{ secrets.SERVER_ACCESS_KEY }}
            SERVER_SECRET_KEY=${{ secrets.SERVER_SECRET_KEY }}
            S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}
            HOST=${{ secrets.HOST }}
            EOL
            
            docker stop yummypass-container || true
            docker rm yummypass-container || true
      
            docker pull chamingyeong/yummypass:latest
            docker run -d -p 8080:8080 --name yummypass-container --env-file .env chamingyeong/yummypass:latest
            
            echo "Containers status:"
            sudo docker ps -a
            
            docker image prune -f || true

            echo "==== DEPLOY COMPLETED SUCCESSFULLY ===="
